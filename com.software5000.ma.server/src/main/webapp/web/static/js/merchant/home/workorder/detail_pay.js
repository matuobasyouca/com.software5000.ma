webpackJsonp([8],{178:function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=a(273),i=a.n(s),o=a(6),n=a.n(o);t.default={components:{maining:i.a,maHead:n.a},data:function(){return{isLoading:!0}}}},179:function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=a(1);t.default={name:"maining",data:function(){return{context:this,canSubmit:!0,orderTimer:null,orderNo:"",carNumber:"",realName:"",mobile:"",userId:"",memberRecordId:"",memberLvl:"",comment:"",memberBalance:0,memberBalanceDeduct:0,packageRemain:{},itemDatas:[],itemColumns:[{title:"已选项目",key:"serviceItemName",width:152},{title:"售价",width:76,render:function(e){return parseFloat(e.salePrice).toFixed(2)}},{title:"数量",width:64,className:"item-times",render:function(e){return e.itemsTimes}},{title:"卡券抵扣",width:196,render:function(e,t,i,o){var n=[];return o.couponsData.forEach(function(e){o.handleCouponListShow(e,i)&&n.push(e)}),a.i(s.c)(e.couponUuid)?n.length>0?'<p class="ten-cross" @click="handlePopCoupon('+e.itemType+","+i+')"><i></i></p>':"<span>无可用卡券</span>":'<span class="coupon-deduct use-coupon zs-coupon" @click="handlePopCoupon('+e.itemType+","+i+')">'+e.couponName+" (-"+e.couponDeduct+")</span>"}},{title:"会员扣减",width:82,render:function(e,t,a,s){var i=0,o=(e.itemsTimes-(e._useCard?s.handlePackageDeductTimes(e,a):0))*e.salePrice-(e.couponDeduct||0);if(1==e.discountType)i=parseFloat((1-(e.discountNumber||10)/10)*o).toFixed(2);else if(2==e.discountType){var n=(e.itemsTimes-(e._useCard?s.handlePackageDeductTimes(e,a):0))*(e.salePrice-(e.discountNumber||0));i=parseFloat(n-o>0?o:n).toFixed(2)}return s.$set(s.itemDatas[a],"discountPrice",parseFloat(i)),"-"+i}},{title:"总金额",width:84,render:function(e,t,a,s){var i=parseFloat((e.itemsTimes-(e._useCard?s.handlePackageDeductTimes(e,a):0))*e.salePrice-(e.couponDeduct||0)-e.discountPrice).toFixed(2);return s.$set(s.itemDatas[a],"totalPrice",parseFloat(i)),i}},{title:"派工人员",width:84,render:function(e){return e.workerName||"/"}},{title:"销售人员",width:84,render:function(e){return e.salerName||"/"}},{title:"使用套餐",width:126,className:"item-control",render:function(e,t,a,s){return e._hasCard?'\n                            <p class="table-switch-wrap '+(e._useCard?"is-usecard":"")+'">\n                                <span class="table-switch" @click="handleToggleUseCard('+a+')"></span>\n                                '+(e._useCard?"x "+s.handlePackageDeductTimes(e,a):"不用卡")+"\n                            </p>":""}}],currItemIndex:"",currItemType:"",couponSelectVisible:!1,couponsData:[],couponsItemData:[],couponKey:1,finalData:{id:"",totalPrice:"",workOrderDetails:[],businessDeduct:"",materialCost:"",payType:""},payCashPopVisible:!1,payWechatPopVisible:!1,items:[]}},computed:{itemTotalPrice:function(){var e=0;return this.itemDatas.forEach(function(t){e+=parseFloat(t.totalPrice)}),parseFloat(e).toFixed(2)},totalPriceBeforeDeduct:function(){return(parseFloat(this.itemTotalPrice)+parseFloat(this.finalData.materialCost||0)).toFixed(2)},totalPriceBeforeBalance:function(){var e=this.totalPriceBeforeDeduct-(this.finalData.businessDeduct||0);return parseFloat(e>0?e:0).toFixed(2)},totalPrice:function(){var e=this.totalPriceBeforeBalance-this.memberBalanceDeduct;return parseFloat(e>0?e:0).toFixed(2)}},watch:{payWechatPopVisible:function(e){!e&&clearInterval(this.orderTimer)}},methods:{updateWorkOrder:function(e,t){var a=this;this.finalData.businessDeduct=1*Math.min(parseFloat(this.finalData.businessDeduct||0),this.totalPriceBeforeDeduct).toFixed(2),this.finalData.materialCost=1*parseFloat(this.finalData.materialCost||0).toFixed(2),this.finalData.balanceDeduct=Math.min(parseFloat(this.memberBalanceDeduct),parseFloat(this.totalPriceBeforeBalance)).toFixed(2),this.finalData.totalPrice=parseFloat(this.totalPrice),this.itemDatas.forEach(function(e){e.usePackageTimes=e._useCard?e.usePackageTimes:0}),this.finalData.workOrderDetails=this.itemDatas,this.$ajax(this.$joggle.merchant.workorder.updateWorkOrder,this.finalData,t,function(t,s){"ZS011000"===t.code?e&&e():(s.close(),a.$message({type:"error",message:t.msg,duration:1200}))})},updateWorkOrderForSettle:function(){var e=this;this.$ajax(this.$joggle.merchant.workorder.updateWorkOrderForSettle,{orderId:this.finalData.id},!0,function(t,i){i.close(),"ZS011000"===t.code?(e.$message({type:"success",message:"收款成功",duration:1200}),setTimeout(function(){a.i(s.a)("/web/merchant/home/workorder/detail_balance.html",{id:e.finalData.id})},1200)):e.$message({type:"error",message:"收款失败",duration:1200})})},selectWorkOrder:function(e,t){var i=this;this.$ajax(this.$joggle.merchant.workorder.selectWorkOrderById,{orderId:this.finalData.id},t,function(t,o){if("ZS011000"===t.code){var n=t.data.workOrder,r=t.data.user;if(a.i(s.c)(n))i.$message({type:"error",message:"工单不存在!",duration:1200}),i.canSubmit=!1;else if(4==n.state)i.$message({type:"error",message:"该工单已结算!",duration:1200}),i.canSubmit=!1;else{i.carNumber=n.carNumber,i.orderNo=n.orderNo,i.comment=n.comment||"",i.mobile=n.mobile||"----",i.memberRecordId=a.i(s.c)(r)?"":r.recordId||"",i.userId=a.i(s.c)(r)?"":r.userId||"",i.memberLvl=a.i(s.c)(i.memberRecordId)?"非会员":r.lvlName||"普通会员",i.realName=a.i(s.c)(r)?"--":r.realName||"--",i.finalData.materialCost=n.materialCost||"",i.finalData.businessDeduct=n.businessDeduct||"",i.packageRemain=i.handlePackageMerge(a.i(s.c)(r)?[]:r.packageList),i.memberBalance=a.i(s.c)(r)?0:r.memberBalance||0,i.memberBalanceDeduct=n.balanceDeduct?r.memberBalance:0;var c=a.i(s.c)(n)?[]:n.workOrderDetails||[],l=new Promise(function(e){i.selectCouponsByCarNumber(function(){e()},o)}),u=new Promise(function(e){i.selectServiceItem(function(){e()},o)});Promise.all([l,u]).then(function(){c.forEach(function(e){i.items.forEach(function(t){t.id===e.serviceItemId&&(i.$set(e,"discountNumber",t.discountNumber),i.$set(e,"discountType",t.discountType))}),e._readonly=!0,e._hasCard=e._useCard=!1,(a.i(s.c)(e.itemType)||a.i(s.c)(e.serviceItemId))&&(e.itemType=-1);for(var t in i.packageRemain)if(i.packageRemain[t]>0&&t==e.serviceItemId){e._hasCard=!0,e._useCard=parseInt(e.usePackageTimes||0)>0;break}i.$set(e,"couponKey",i.couponKey);var o=!1;a.i(s.c)(e.couponUuid)||(i.couponsData.forEach(function(t){e.couponUuid===t.takeUuid&&(i.$set(t,"couponKey",i.couponKey),o=!0)}),o||(i.$set(e,"couponUuid",""),i.$set(e,"couponName",""),i.$set(e,"couponDeduct",""))),i.couponKey++}),i.itemDatas=c,e&&e()})}}else o.close(),i.$message({type:"error",message:t.msg,duraton:1200})})},selectCouponsByCarNumber:function(e,t){var a=this;this.$ajax(this.$joggle.merchant.workorder.selectCouponsByCarNumber,{carNumber:this.carNumber},t,function(t){"ZS011000"===t.code?a.couponsData=t.data:a.$message({type:"error",message:t.msg,duration:1200}),e&&e()})},selectServiceItem:function(e,t){var a=this;this.$ajax(this.$joggle.merchant.workorder.selectServiceItem,{startPage:1,pageSize:999,itemType:"",userId:this.userId},t,function(t){"ZS011000"===t.code?a.items=t.data.list:a.$message({type:"error",message:t.msg}),e&&e()})},selectCouponsById:function(e,t){var i=this,o=[];if(this.couponsData.forEach(function(e){a.i(s.c)(e.couponKey)||o.push(e.takeUuid)}),0===o.length)return void(e&&e());this.$ajax(this.$joggle.merchant.workorder.selectCouponsById,{uuid:o.join(",")},t,function(t,a){"ZS011000"===t.code?e&&e():(a.close(),i.$message({type:"error",message:"有卡券不可使用，请刷新页面重试！",duration:1200}))})},selectWorkorderState:function(e,t){var a=this;this.$ajax(this.$joggle.merchant.workorder.selectWorkOrderById,{orderId:this.finalData.id},!1,function(s){"ZS011000"===s.code?4===parseInt(s.data.workOrder.state)?e&&e():t&&t():a.$message({type:"error",message:s.msg,duration:1200})})},handleToggleUseCard:function(e){var t=this,a=this.itemDatas[e];if(this.$set(a,"_useCard",!a._useCard),a._useCard){this.$set(a,"couponUuid",""),this.$set(a,"couponName",""),this.$set(a,"couponDeduct",0);for(var s=0;s<this.couponsData.length;s++)if(t.couponsData[s].couponKey===a.couponKey){t.$set(t.couponsData[s],"couponKey","");break}}},handlePackageMerge:function(e){var t={1:0};if(e.length>0)for(var a=0;a<e.length;a++)if(e[a].memberItemUseRecords.length>0)for(var s=e[a].memberItemUseRecords,i=0;i<s.length;i++){var o=!0;for(var n in t)if(parseInt(n)===parseInt(s[i].serviceItem.id)){t[n]=parseInt(t[n])+parseInt(s[i].remainTimes),o=!1;break}o&&(t[s[i].serviceItem.id]=s[i].remainTimes)}return t},handlePackageDeductTimes:function(e,t){if(e._useCard){var a=[e.itemsTimes,this.packageRemain[e.serviceItemId]||0];this.$set(this.itemDatas[t],"usePackageTimes",Math.min.apply(Math,a))}return parseInt(e.usePackageTimes)},handlePopCoupon:function(e,t){var a=this;if(this.itemDatas[t]._useCard)return void this.$message({type:"warning",message:"已选择使用套餐，不能使用优惠券！"});this.currItemIndex=t,this.currItemType=e||"-1";var s=[];this.couponsData.forEach(function(e,t){a.handleCouponListShow(e)&&(e._index=t,s.push(e))}),this.couponsItemData=s,this.couponSelectVisible=!0},handleCouponListShow:function(e,t){t=a.i(s.c)(t)?this.currItemIndex:t;var i=this.itemDatas[t];if(a.i(s.c)(i))return!1;var o=i.itemType||-1;return(!e.couponKey||e.couponKey==i.couponKey)&&(!e.coupon.itemType||e.coupon.itemType==o)&&e.coupon.cpMoney-i.itemsTimes*i.salePrice<=0},handleSelectCoupon:function(e){for(var t=this,a=this.itemDatas[this.currItemIndex],s=0;s<this.couponsData.length;s++)t.couponsData[s].takeUuid===e&&(t.couponsData[s].couponKey===a.couponKey?(t.$set(t.couponsData[s],"couponKey",""),t.$set(a,"couponUuid",""),t.$set(a,"couponName",""),t.$set(a,"couponDeduct",0)):(t.couponsItemData.forEach(function(e){t.$set(e,"couponKey",""),t.$set(t.couponsData[e._index],"couponKey","")}),t.$set(t.couponsData[s],"couponKey",a.couponKey),t.$set(a,"couponUuid",t.couponsData[s].takeUuid),t.$set(a,"couponName",t.couponsData[s].coupon.cpName),t.$set(a,"couponDeduct",t.couponsData[s].coupon.cpMoney)));this.couponSelectVisible=!1},handlePayCashPop:function(){var e=this;if(this.canSubmit){this.finalData.payType=1;var t=this.$loading();this.selectCouponsById(function(){e.updateWorkOrder(function(){e.payCashPopVisible=!0,t.close()},t)},t)}},handlePayWechatPop:function(){var e=this;if(this.canSubmit&&0!==parseFloat(this.totalPrice)){this.finalData.payType=2;var t=this.$loading();this.selectCouponsById(function(){e.updateWorkOrder(function(){e.payWechatPopVisible=!0,e.handleShowBarCode(),t.close()},t)},t)}},handleShowBarCode:function(){var e=this;a.i(s.e)(this.$joggle.merchant.workorder.weChatPayBarCode+"?orderId="+this.finalData.id+"&totalPrice="+this.finalData.totalPrice+"&t="+(new Date).getTime(),function(t){e.$refs.barCodeWrap.innerHTML="",e.$refs.barCodeWrap.appendChild(t),clearInterval(e.orderTimer),e.orderTimer=setInterval(function(){e.selectWorkorderState(function(){e.payWechatPopVisible=!1,e.$message({type:"success",message:"支付成功",duration:1200}),setTimeout(function(){a.i(s.a)("/web/merchant/home/workorder/detail_balance.html",{id:e.finalData.id})},1200)})},2e3)})}},created:function(){var e=this;if(this.finalData.id=a.i(s.f)("id")||"",a.i(s.c)(this.finalData.id))return this.$message({type:"error",message:"工单不存在!",duration:1200}),void(this.canSubmit=!1);var t=this.$loading();this.selectWorkOrder(function(){t.close(),e.$emit("input",!1)},t)}}},272:function(e,t,a){function s(e){a(397)}var i=a(0)(a(178),a(306),s,null,null);e.exports=i.exports},273:function(e,t,a){function s(e){a(404)}var i=a(0)(a(179),a(319),s,null,null);e.exports=i.exports},306:function(e,t){e.exports={render:function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{directives:[{name:"show",rawName:"v-show",value:!e.isLoading,expression:"!isLoading"}],staticClass:"workorder-page"},[a("ma-head",{attrs:{"curr-id":"02"}}),e._v(" "),a("zs-breadcrumb",{attrs:{separator:"arrow-right"}},[a("zs-breadcrumb-item",{attrs:{to:"/web/merchant/home/workorder/list_balance.html"}},[e._v("工单结算")]),e._v(" "),a("zs-breadcrumb-item",[e._v("去结算")])],1),e._v(" "),a("maining",{tag:"component",model:{value:e.isLoading,callback:function(t){e.isLoading=t},expression:"isLoading"}})],1)},staticRenderFns:[]}},319:function(e,t,a){e.exports={render:function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("div",{staticClass:"page-main"},[s("div",{staticClass:"page-main-body"},[s("ul",{staticClass:"user-detail"},[s("li",[s("span",[e._v("工单编号：")]),e._v(e._s(e.orderNo))]),e._v(" "),s("li",[s("span",[e._v("车牌：")]),e._v(e._s(e.carNumber))]),e._v(" "),s("li",[s("span",[e._v("姓名：")]),e._v(e._s(e.realName))]),e._v(" "),s("li",[s("span",[e._v("手机号：")]),e._v(e._s(e.mobile))]),e._v(" "),s("li",[s("span",[e._v("会员等级：")]),e._v(e._s(e.memberLvl))]),e._v(" "),s("li",[s("span",[e._v("备注：")]),e._v(e._s(e.comment))])]),e._v(" "),s("zs-table",{staticClass:"item-table",attrs:{data:e.itemDatas,columns:e.itemColumns,context:e.context,"no-data-colspan":9,border:""}}),e._v(" "),s("ul",{staticClass:"account-detail"},[s("li",[s("div",{staticClass:"account-detail-item"},[s("span",{staticClass:"account-1"},[e._v("项目费用")]),e._v(" "),s("span",{staticClass:"account-2"},[e._v(e._s(e.itemTotalPrice))])])]),e._v(" "),s("li",[s("div",{staticClass:"account-detail-item"},[s("span",{staticClass:"account-1"},[e._v("附加费用")]),e._v(" "),s("div",{staticClass:"account-2"},[s("zs-input",{attrs:{type:"number","auto-select":0==e.finalData.materialCost},model:{value:e.finalData.materialCost,callback:function(t){e.finalData.materialCost=t},expression:"finalData.materialCost"}})],1)])]),e._v(" "),s("li",[s("div",{staticClass:"account-detail-item"},[s("span",{staticClass:"account-1"},[e._v("商家扣减")]),e._v(" "),s("div",{staticClass:"account-2"},[e._v("\n                        -\n                        "),s("zs-input",{attrs:{type:"number","auto-select":0==e.finalData.businessDeduct},model:{value:e.finalData.businessDeduct,callback:function(t){e.finalData.businessDeduct=t},expression:"finalData.businessDeduct"}})],1)])]),e._v(" "),e.memberBalance>0?s("li",{staticClass:"member-balance"},[s("div",{staticClass:"account-detail-item"},[s("span",{staticClass:"account-1"}),e._v(" "),s("zs-checkbox",{attrs:{"true-label":e.memberBalance,"false-label":0},model:{value:e.memberBalanceDeduct,callback:function(t){e.memberBalanceDeduct=t},expression:"memberBalanceDeduct"}},[e._v("会员余额支付 "),s("i",[e._v("(余额:"+e._s(parseFloat(e.memberBalance).toFixed(2))+")")])]),e._v(" "),s("span",{staticClass:"account-2"},[e._v("- "+e._s(Math.min(parseFloat(e.memberBalanceDeduct),parseFloat(e.totalPriceBeforeBalance)).toFixed(2)))])],1)]):e._e()]),e._v(" "),s("ul",{staticClass:"account-detail"},[s("li",{staticClass:"account-sum"},[s("div",{staticClass:"account-detail-item"},[s("span",{staticClass:"account-2"},[e._v("实际应收："),s("i",[e._v("￥"+e._s(e.totalPrice))])])])])])],1),e._v(" "),s("div",{staticClass:"page-main-footer"},[s("zs-button",{class:[{"is-disabled":!e.canSubmit}],attrs:{type:"primary"},on:{click:e.handlePayCashPop}},[s("zs-icon",{attrs:{icon:"cash",size:"24",text:"现金收款"}})],1),e._v(" "),s("zs-button",{class:[{"is-disabled":!e.canSubmit||0===parseFloat(e.totalPrice)}],attrs:{type:"success"},on:{click:e.handlePayWechatPop}},[s("zs-icon",{attrs:{icon:"wechat",size:"24",text:"微信收款"}})],1)],1),e._v(" "),s("zs-dialog",{staticClass:"settle-pop",model:{value:e.payCashPopVisible,callback:function(t){e.payCashPopVisible=t},expression:"payCashPopVisible"}},[s("p",{slot:"title"},[e._v("现金收款")]),e._v(" "),s("p",{staticClass:"pay-pop-p1"},[e._v("￥"+e._s(e.totalPrice))]),e._v(" "),s("p",{staticClass:"pay-pop-p2"},[e._v('请收到现金后点击"确认收款"!')]),e._v(" "),s("template",{slot:"footer"},[s("zs-button",{attrs:{type:"cancel"},on:{click:function(t){e.payCashPopVisible=!1}}},[e._v("取消\n            ")]),e._v(" "),s("zs-button",{attrs:{type:"primary"},on:{click:e.updateWorkOrderForSettle}},[e._v("确定收款\n            ")])],1)],2),e._v(" "),s("zs-dialog",{staticClass:"settle-pop wechat-pay-pop",model:{value:e.payWechatPopVisible,callback:function(t){e.payWechatPopVisible=t},expression:"payWechatPopVisible"}},[s("p",{slot:"title"},[e._v("微信收款")]),e._v(" "),s("p",{staticClass:"pay-pop-p1"},[e._v("￥"+e._s(e.totalPrice))]),e._v(" "),s("p",{ref:"barCodeWrap",staticClass:"pay-pop-barcode"},[s("img",{staticClass:"pay-pop-loading",attrs:{src:a(18)}})])]),e._v(" "),s("zs-dialog",{staticClass:"select-pop coupon-select-pop",model:{value:e.couponSelectVisible,callback:function(t){e.couponSelectVisible=t},expression:"couponSelectVisible"}},[s("p",{slot:"title"},[e._v("选择优惠券")]),e._v(" "),s("ul",{staticClass:"employee-select-list"},[s("li",{staticClass:"employee-select-hd"},[s("span",[e._v("选择")]),s("span",[e._v("优惠券名称")]),s("span",[e._v("优惠券金额")])]),e._v(" "),e.couponsItemData.length>0?e._l(e.couponsItemData,function(t,a){return e.handleCouponListShow(t)?s("li",{key:t.id,on:{click:function(a){e.handleSelectCoupon(t.takeUuid)}}},[s("span",[s("i",{staticClass:"table-radio",class:[{curr:t.couponKey===e.itemDatas[e.currItemIndex].couponKey}]})]),e._v(" "),s("span",[e._v(e._s(t.coupon.cpName))]),e._v(" "),s("span",[e._v(e._s(t.coupon.cpMoney))])]):e._e()}):s("li",{staticClass:"employee-empty"},[s("p",[e._v("暂无可用优惠券")])])],2)])],1)},staticRenderFns:[]}},397:function(e,t){},404:function(e,t){},470:function(e,t,a){e.exports=a(60)},60:function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=a(2),i=a(272),o=a.n(i),n=a(5),r=(a.n(n),a(3),a(4));s.a.use(r.a),new s.a({el:"#app",render:function(e){return e(o.a)}})}},[470]);